<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# OPTIONS_GHC -Wno-redundant-constraints #-}</span><span>
</span><a name="line-2"></a><span>
</span><a name="line-3"></a><span class="hs-comment">-- | Elemental building blocks for migrations.</span><span>
</span><a name="line-4"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Lorentz.UStore.Migration.Blocks</span><span>
</span><a name="line-5"></a><span>  </span><span class="hs-special">(</span><span> </span><span class="hs-comment">-- * General</span><span>
</span><a name="line-6"></a><span>    </span><a href="Lorentz.UStore.Migration.Blocks.html#mustoreToOld"><span class="hs-identifier hs-var">mustoreToOld</span></a><span>
</span><a name="line-7"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Lorentz.UStore.Migration.Blocks.html#MigrationFinishCheckPosition"><span class="hs-identifier hs-type">MigrationFinishCheckPosition</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span>    </span><span class="hs-comment">-- * Elemental steps</span><span>
</span><a name="line-10"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Lorentz.UStore.Migration.Blocks.html#migrateCoerceUnsafe"><span class="hs-identifier hs-var">migrateCoerceUnsafe</span></a><span>
</span><a name="line-11"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Lorentz.UStore.Migration.Blocks.html#migrateGetField"><span class="hs-identifier hs-var">migrateGetField</span></a><span>
</span><a name="line-12"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Lorentz.UStore.Migration.Blocks.html#migrateAddField"><span class="hs-identifier hs-var">migrateAddField</span></a><span>
</span><a name="line-13"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Lorentz.UStore.Migration.Blocks.html#migrateRemoveField"><span class="hs-identifier hs-var">migrateRemoveField</span></a><span>
</span><a name="line-14"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Lorentz.UStore.Migration.Blocks.html#migrateExtractField"><span class="hs-identifier hs-var">migrateExtractField</span></a><span>
</span><a name="line-15"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Lorentz.UStore.Migration.Blocks.html#migrateOverwriteField"><span class="hs-identifier hs-var">migrateOverwriteField</span></a><span>
</span><a name="line-16"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Lorentz.UStore.Migration.Blocks.html#migrateModifyField"><span class="hs-identifier hs-var">migrateModifyField</span></a><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span>    </span><span class="hs-comment">-- * Migration batches</span><span>
</span><a name="line-19"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Lorentz.UStore.Migration.Blocks.html#muBlock"><span class="hs-identifier hs-var">muBlock</span></a><span>
</span><a name="line-20"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Lorentz.UStore.Migration.Blocks.html#muBlockNamed"><span class="hs-identifier hs-var">muBlockNamed</span></a><span>
</span><a name="line-21"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="Lorentz.UStore.Migration.Blocks.html#%3C--%3E"><span class="hs-operator hs-var">&lt;--&gt;</span></a><span class="hs-special">)</span><span>
</span><a name="line-22"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><a href="Lorentz.UStore.Migration.Blocks.html#%24%3A"><span class="hs-operator hs-var">$:</span></a><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-24"></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="Lorentz.Base.html"><span class="hs-identifier">Lorentz.Base</span></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><a href="Lorentz.Coercions.html"><span class="hs-identifier">Lorentz.Coercions</span></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><a href="Lorentz.Instr.html"><span class="hs-identifier">Lorentz.Instr</span></a><span> </span><span class="hs-special">(</span><a href="Lorentz.Instr.html#dip"><span class="hs-identifier hs-var">dip</span></a><span class="hs-special">)</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><a href="Lorentz.UStore.Instr.html"><span class="hs-identifier">Lorentz.UStore.Instr</span></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="Lorentz.UStore.Migration.Base.html"><span class="hs-identifier">Lorentz.UStore.Migration.Base</span></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="Lorentz.UStore.Migration.Diff.html"><span class="hs-identifier">Lorentz.UStore.Migration.Diff</span></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="Lorentz.UStore.Types.html"><span class="hs-identifier">Lorentz.UStore.Types</span></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util.Label</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Label</span><span class="hs-special">)</span><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util.Type</span><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Util.TypeLits</span><span>
</span><a name="line-35"></a><span>
</span><a name="line-36"></a><span class="hs-comment">-- | Helper for 'mustoreToOld' which ensures that given store hasn't been</span><span>
</span><a name="line-37"></a><span class="hs-comment">-- (partially) migrated yet.</span><span>
</span><a name="line-38"></a><span class="hs-keyword">type</span><span> </span><span class="hs-keyword">family</span><span> </span><a name="RequireBeInitial"><a href="Lorentz.UStore.Migration.Blocks.html#RequireBeInitial"><span class="hs-identifier">RequireBeInitial</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679600670"><a href="#local-6989586621679600670"><span class="hs-identifier">touched</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Symbol</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Constraint</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-39"></a><span>  </span><span class="hs-identifier">RequireBeInitial</span><span> </span><span class="hs-special">'</span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-40"></a><span>  </span><span class="hs-identifier">RequireBeInitial</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-41"></a><span>    </span><span class="hs-identifier hs-type">TypeError</span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-string">&quot;Migration has already been started over this store&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-42"></a><span>
</span><a name="line-43"></a><span class="hs-keyword">type</span><span> </span><span class="hs-keyword">family</span><span> </span><a name="RequireUntouched"><a href="Lorentz.UStore.Migration.Blocks.html#RequireUntouched"><span class="hs-identifier">RequireUntouched</span></a></a><span> </span><span class="hs-special">(</span><a name="local-6989586621679600666"><a href="#local-6989586621679600666"><span class="hs-identifier">field</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Symbol</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a name="local-6989586621679600667"><a href="#local-6989586621679600667"><span class="hs-identifier">wasTouched</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Bool</span><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span>             </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Constraint</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-45"></a><span>  </span><span class="hs-identifier">RequireUntouched</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">'</span><span class="hs-identifier hs-type">False</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-46"></a><span>  </span><span class="hs-identifier">RequireUntouched</span><span> </span><a href="#local-6989586621679600669"><span class="hs-identifier hs-type">field</span></a><span> </span><span class="hs-special">'</span><span class="hs-identifier hs-type">True</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">TypeError</span><span>
</span><a name="line-47"></a><span>    </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Field `&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-type">AppendSymbol</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679600669"><span class="hs-identifier hs-type">field</span></a><span> </span><span class="hs-special">`</span><span class="hs-identifier">AppendSymbol</span><span class="hs-special">`</span><span> </span><span class="hs-string">&quot;` has already been \
            \migrated and cannot be read&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-49"></a><span>    </span><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span>
</span><a name="line-51"></a><span class="hs-comment">-- | Cast field or submap pretending that its value fits to the new type.</span><span>
</span><a name="line-52"></a><span class="hs-comment">--</span><span>
</span><a name="line-53"></a><span class="hs-comment">-- Useful when type of field, e.g. lambda or set of lambdas, is polymorphic</span><span>
</span><a name="line-54"></a><span class="hs-comment">-- over storage type.</span><span>
</span><a name="line-55"></a><span class="hs-identifier">migrateCoerceUnsafe</span><span>
</span><a name="line-56"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679600764"><a href="#local-6989586621679600764"><span class="hs-identifier">field</span></a></a><span> </span><a name="local-6989586621679600765"><a href="#local-6989586621679600765"><span class="hs-identifier">oldTempl</span></a></a><span> </span><a name="local-6989586621679600766"><a href="#local-6989586621679600766"><span class="hs-identifier">newTempl</span></a></a><span> </span><a name="local-6989586621679600767"><a href="#local-6989586621679600767"><span class="hs-identifier">diff</span></a></a><span> </span><a name="local-6989586621679600768"><a href="#local-6989586621679600768"><span class="hs-identifier">touched</span></a></a><span> </span><a name="local-6989586621679600769"><a href="#local-6989586621679600769"><span class="hs-identifier">newDiff</span></a></a><span> </span><a name="local-6989586621679600770"><a href="#local-6989586621679600770"><span class="hs-identifier">newDiff0</span></a></a><span> </span><a name="local-6989586621679600771"><a href="#local-6989586621679600771"><span class="hs-identifier">_1</span></a></a><span> </span><a name="local-6989586621679600772"><a href="#local-6989586621679600772"><span class="hs-identifier">_2</span></a></a><span> </span><a name="local-6989586621679600773"><a href="#local-6989586621679600773"><span class="hs-identifier">s</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-57"></a><span>     </span><span class="hs-special">(</span><span> </span><span class="hs-special">'</span><span class="hs-special">(</span><a href="#local-6989586621679600771"><span class="hs-identifier hs-type">_1</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679600770"><span class="hs-identifier hs-type">newDiff0</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">~</span><span> </span><a href="Lorentz.UStore.Migration.Diff.html#CoverDiff"><span class="hs-identifier hs-type">CoverDiff</span></a><span> </span><span class="hs-special">'</span><a href="Lorentz.UStore.Migration.Diff.html#DcRemove"><span class="hs-identifier hs-type">DcRemove</span></a><span> </span><a href="#local-6989586621679600764"><span class="hs-identifier hs-type">field</span></a><span> </span><a href="#local-6989586621679600767"><span class="hs-identifier hs-type">diff</span></a><span>
</span><a name="line-58"></a><span>     </span><span class="hs-special">,</span><span> </span><span class="hs-special">'</span><span class="hs-special">(</span><a href="#local-6989586621679600772"><span class="hs-identifier hs-type">_2</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679600769"><span class="hs-identifier hs-type">newDiff</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">~</span><span> </span><a href="Lorentz.UStore.Migration.Diff.html#CoverDiff"><span class="hs-identifier hs-type">CoverDiff</span></a><span> </span><span class="hs-special">'</span><a href="Lorentz.UStore.Migration.Diff.html#DcAdd"><span class="hs-identifier hs-type">DcAdd</span></a><span> </span><a href="#local-6989586621679600764"><span class="hs-identifier hs-type">field</span></a><span> </span><a href="#local-6989586621679600770"><span class="hs-identifier hs-type">newDiff0</span></a><span>
</span><a name="line-59"></a><span>     </span><span class="hs-special">)</span><span>
</span><a name="line-60"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Label</span><span> </span><a href="#local-6989586621679600764"><span class="hs-identifier hs-type">field</span></a><span>
</span><a name="line-61"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Lorentz.Base.html#%3A-%3E"><span class="hs-identifier hs-type">MUStore</span></a><span> </span><a href="#local-6989586621679600765"><span class="hs-identifier hs-type">oldTempl</span></a><span> </span><a href="#local-6989586621679600766"><span class="hs-identifier hs-type">newTempl</span></a><span> </span><a href="#local-6989586621679600767"><span class="hs-identifier hs-type">diff</span></a><span> </span><a href="#local-6989586621679600768"><span class="hs-identifier hs-type">touched</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679600773"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-62"></a><span>  </span><span class="hs-operator">:-&gt;</span><span> </span><span class="hs-identifier hs-type">MUStore</span><span> </span><a href="#local-6989586621679600765"><span class="hs-identifier hs-type">oldTempl</span></a><span> </span><a href="#local-6989586621679600766"><span class="hs-identifier hs-type">newTempl</span></a><span> </span><a href="#local-6989586621679600769"><span class="hs-identifier hs-type">newDiff</span></a><span> </span><a href="#local-6989586621679600768"><span class="hs-identifier hs-type">touched</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679600773"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-63"></a><a name="migrateCoerceUnsafe"><a href="Lorentz.UStore.Migration.Blocks.html#migrateCoerceUnsafe"><span class="hs-identifier">migrateCoerceUnsafe</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-64"></a><span>  </span><a href="Lorentz.Coercions.html#forcedCoerce_"><span class="hs-identifier hs-var">forcedCoerce_</span></a><span>
</span><a name="line-65"></a><span>
</span><a name="line-66"></a><span class="hs-comment">-- Migrating fields</span><span>
</span><a name="line-67"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-68"></a><span>
</span><a name="line-69"></a><span class="hs-comment">-- | Get a field present in old version of 'UStore'.</span><span>
</span><a name="line-70"></a><span class="hs-identifier">migrateGetField</span><span>
</span><a name="line-71"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679600757"><a href="#local-6989586621679600757"><span class="hs-identifier">field</span></a></a><span> </span><a name="local-6989586621679600758"><a href="#local-6989586621679600758"><span class="hs-identifier">oldTempl</span></a></a><span> </span><a name="local-6989586621679600759"><a href="#local-6989586621679600759"><span class="hs-identifier">newTempl</span></a></a><span> </span><a name="local-6989586621679600760"><a href="#local-6989586621679600760"><span class="hs-identifier">diff</span></a></a><span> </span><a name="local-6989586621679600761"><a href="#local-6989586621679600761"><span class="hs-identifier">touched</span></a></a><span> </span><a name="local-6989586621679600762"><a href="#local-6989586621679600762"><span class="hs-identifier">fieldTy</span></a></a><span> </span><a name="local-6989586621679600763"><a href="#local-6989586621679600763"><span class="hs-identifier">s</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-72"></a><span>     </span><span class="hs-special">(</span><span> </span><a href="Lorentz.UStore.Instr.html#HasUField"><span class="hs-identifier hs-type">HasUField</span></a><span> </span><a href="#local-6989586621679600757"><span class="hs-identifier hs-type">field</span></a><span> </span><a href="#local-6989586621679600762"><span class="hs-identifier hs-type">fieldTy</span></a><span> </span><a href="#local-6989586621679600758"><span class="hs-identifier hs-type">oldTempl</span></a><span>
</span><a name="line-73"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Lorentz.UStore.Migration.Blocks.html#RequireUntouched"><span class="hs-identifier hs-type">RequireUntouched</span></a><span> </span><a href="#local-6989586621679600757"><span class="hs-identifier hs-type">field</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">field</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-type">IsElem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679600761"><span class="hs-identifier hs-type">touched</span></a><span class="hs-special">)</span><span>
</span><a name="line-74"></a><span>     </span><span class="hs-special">)</span><span>
</span><a name="line-75"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Label</span><span> </span><a href="#local-6989586621679600757"><span class="hs-identifier hs-type">field</span></a><span>
</span><a name="line-76"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Lorentz.Base.html#%3A-%3E"><span class="hs-identifier hs-type">MUStore</span></a><span> </span><a href="#local-6989586621679600758"><span class="hs-identifier hs-type">oldTempl</span></a><span> </span><a href="#local-6989586621679600759"><span class="hs-identifier hs-type">newTempl</span></a><span> </span><a href="#local-6989586621679600760"><span class="hs-identifier hs-type">diff</span></a><span> </span><a href="#local-6989586621679600761"><span class="hs-identifier hs-type">touched</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679600763"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-77"></a><span>  </span><span class="hs-operator">:-&gt;</span><span> </span><span class="hs-identifier hs-type">fieldTy</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-type">MUStore</span><span> </span><a href="#local-6989586621679600758"><span class="hs-identifier hs-type">oldTempl</span></a><span> </span><a href="#local-6989586621679600759"><span class="hs-identifier hs-type">newTempl</span></a><span> </span><a href="#local-6989586621679600760"><span class="hs-identifier hs-type">diff</span></a><span> </span><a href="#local-6989586621679600761"><span class="hs-identifier hs-type">touched</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679600763"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-78"></a><a name="migrateGetField"><a href="Lorentz.UStore.Migration.Blocks.html#migrateGetField"><span class="hs-identifier">migrateGetField</span></a></a><span> </span><span class="hs-keyword">label</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-79"></a><span>  </span><a href="Lorentz.Coercions.html#forcedCoerce_"><span class="hs-identifier hs-var">forcedCoerce_</span></a><span> </span><span class="hs-glyph">@</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Lorentz.UStore.Types.html#UStore"><span class="hs-identifier hs-type">UStore</span></a><span> </span><a href="#local-6989586621679600758"><span class="hs-identifier hs-type">oldTempl</span></a><span class="hs-special">)</span><span> </span><a href="Lorentz.Base.html#%23"><span class="hs-operator hs-var">#</span></a><span> </span><a href="Lorentz.UStore.Instr.html#ustoreGetField"><span class="hs-identifier hs-var">ustoreGetField</span></a><span> </span><span class="hs-keyword">label</span><span> </span><a href="Lorentz.Base.html#%23"><span class="hs-operator hs-var">#</span></a><span> </span><a href="Lorentz.Instr.html#dip"><span class="hs-identifier hs-var">dip</span></a><span> </span><a href="Lorentz.Coercions.html#forcedCoerce_"><span class="hs-identifier hs-var">forcedCoerce_</span></a><span>
</span><a name="line-80"></a><span>
</span><a name="line-81"></a><span class="hs-comment">-- | Add a field which was not present before.</span><span>
</span><a name="line-82"></a><span class="hs-comment">-- This covers one addition from the diff and any removals of field with given</span><span>
</span><a name="line-83"></a><span class="hs-comment">-- name.</span><span>
</span><a name="line-84"></a><span class="hs-comment">--</span><span>
</span><a name="line-85"></a><span class="hs-comment">-- This function cannot overwrite existing field with the same name, if this</span><span>
</span><a name="line-86"></a><span class="hs-comment">-- is necessary use 'migrateOverwriteField' which would declare removal</span><span>
</span><a name="line-87"></a><span class="hs-comment">-- explicitly.</span><span>
</span><a name="line-88"></a><span class="hs-identifier">migrateAddField</span><span>
</span><a name="line-89"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679600748"><a href="#local-6989586621679600748"><span class="hs-identifier">field</span></a></a><span> </span><a name="local-6989586621679600749"><a href="#local-6989586621679600749"><span class="hs-identifier">oldTempl</span></a></a><span> </span><a name="local-6989586621679600750"><a href="#local-6989586621679600750"><span class="hs-identifier">newTempl</span></a></a><span> </span><a name="local-6989586621679600751"><a href="#local-6989586621679600751"><span class="hs-identifier">diff</span></a></a><span> </span><a name="local-6989586621679600752"><a href="#local-6989586621679600752"><span class="hs-identifier">touched</span></a></a><span> </span><a name="local-6989586621679600753"><a href="#local-6989586621679600753"><span class="hs-identifier">fieldTy</span></a></a><span> </span><a name="local-6989586621679600754"><a href="#local-6989586621679600754"><span class="hs-identifier">newDiff</span></a></a><span> </span><a name="local-6989586621679600755"><a href="#local-6989586621679600755"><span class="hs-identifier">marker</span></a></a><span> </span><a name="local-6989586621679600756"><a href="#local-6989586621679600756"><span class="hs-identifier">s</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-90"></a><span>     </span><span class="hs-special">(</span><span> </span><span class="hs-special">'</span><span class="hs-special">(</span><a href="Lorentz.UStore.Types.html#UStoreFieldExt"><span class="hs-identifier hs-type">UStoreFieldExt</span></a><span> </span><a href="#local-6989586621679600755"><span class="hs-identifier hs-type">marker</span></a><span> </span><a href="#local-6989586621679600753"><span class="hs-identifier hs-type">fieldTy</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679600754"><span class="hs-identifier hs-type">newDiff</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">~</span><span> </span><a href="Lorentz.UStore.Migration.Diff.html#CoverDiff"><span class="hs-identifier hs-type">CoverDiff</span></a><span> </span><span class="hs-special">'</span><a href="Lorentz.UStore.Migration.Diff.html#DcAdd"><span class="hs-identifier hs-type">DcAdd</span></a><span> </span><a href="#local-6989586621679600748"><span class="hs-identifier hs-type">field</span></a><span> </span><a href="#local-6989586621679600751"><span class="hs-identifier hs-type">diff</span></a><span>
</span><a name="line-91"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Lorentz.UStore.Instr.html#HasUField"><span class="hs-identifier hs-type">HasUField</span></a><span> </span><a href="#local-6989586621679600748"><span class="hs-identifier hs-type">field</span></a><span> </span><a href="#local-6989586621679600753"><span class="hs-identifier hs-type">fieldTy</span></a><span> </span><a href="#local-6989586621679600750"><span class="hs-identifier hs-type">newTempl</span></a><span>
</span><a name="line-92"></a><span>     </span><span class="hs-special">)</span><span>
</span><a name="line-93"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Label</span><span> </span><a href="#local-6989586621679600748"><span class="hs-identifier hs-type">field</span></a><span>
</span><a name="line-94"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Lorentz.Base.html#%3A-%3E"><span class="hs-identifier hs-type">fieldTy</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="Lorentz.UStore.Migration.Base.html#MUStore"><span class="hs-identifier hs-type">MUStore</span></a><span> </span><a href="#local-6989586621679600749"><span class="hs-identifier hs-type">oldTempl</span></a><span> </span><a href="#local-6989586621679600750"><span class="hs-identifier hs-type">newTempl</span></a><span> </span><a href="#local-6989586621679600751"><span class="hs-identifier hs-type">diff</span></a><span> </span><a href="#local-6989586621679600752"><span class="hs-identifier hs-type">touched</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679600756"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-95"></a><span>  </span><span class="hs-operator">:-&gt;</span><span> </span><span class="hs-identifier hs-type">MUStore</span><span> </span><a href="#local-6989586621679600749"><span class="hs-identifier hs-type">oldTempl</span></a><span> </span><a href="#local-6989586621679600750"><span class="hs-identifier hs-type">newTempl</span></a><span> </span><a href="#local-6989586621679600754"><span class="hs-identifier hs-type">newDiff</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">field</span><span> </span><span class="hs-special">'</span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679600752"><span class="hs-identifier hs-type">touched</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679600756"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-96"></a><a name="migrateAddField"><a href="Lorentz.UStore.Migration.Blocks.html#migrateAddField"><span class="hs-identifier">migrateAddField</span></a></a><span> </span><span class="hs-keyword">label</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-97"></a><span>  </span><a href="Lorentz.UStore.Migration.Base.html#attachMigrationActionName"><span class="hs-identifier hs-var">attachMigrationActionName</span></a><span> </span><span class="hs-special">(</span><a href="Lorentz.UStore.Migration.Base.html#DAddAction"><span class="hs-identifier hs-var">DAddAction</span></a><span> </span><span class="hs-string">&quot;add&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">label</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Proxy</span><span> </span><span class="hs-glyph">@</span><a href="#local-6989586621679600753"><span class="hs-identifier hs-type">fieldTy</span></a><span class="hs-special">)</span><span> </span><a href="Lorentz.Base.html#%23"><span class="hs-operator hs-var">#</span></a><span>
</span><a name="line-98"></a><span>  </span><a href="Lorentz.Instr.html#dip"><span class="hs-identifier hs-var">dip</span></a><span> </span><span class="hs-special">(</span><a href="Lorentz.Coercions.html#forcedCoerce_"><span class="hs-identifier hs-var">forcedCoerce_</span></a><span> </span><span class="hs-glyph">@</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Lorentz.UStore.Types.html#UStore"><span class="hs-identifier hs-type">UStore</span></a><span> </span><a href="#local-6989586621679600750"><span class="hs-identifier hs-type">newTempl</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="Lorentz.Base.html#%23"><span class="hs-operator hs-var">#</span></a><span> </span><a href="Lorentz.UStore.Instr.html#ustoreSetField"><span class="hs-identifier hs-var">ustoreSetField</span></a><span> </span><span class="hs-keyword">label</span><span> </span><a href="Lorentz.Base.html#%23"><span class="hs-operator hs-var">#</span></a><span> </span><a href="Lorentz.Coercions.html#forcedCoerce_"><span class="hs-identifier hs-var">forcedCoerce_</span></a><span>
</span><a name="line-99"></a><span>
</span><a name="line-100"></a><span class="hs-comment">-- | Remove a field which should not be present in new version of storage.</span><span>
</span><a name="line-101"></a><span class="hs-comment">-- This covers one removal from the diff.</span><span>
</span><a name="line-102"></a><span class="hs-comment">--</span><span>
</span><a name="line-103"></a><span class="hs-comment">-- In fact, this action could be performed automatically, but since</span><span>
</span><a name="line-104"></a><span class="hs-comment">-- removal is a destructive operation, being explicit about it seems</span><span>
</span><a name="line-105"></a><span class="hs-comment">-- like a good thing.</span><span>
</span><a name="line-106"></a><span class="hs-identifier">migrateRemoveField</span><span>
</span><a name="line-107"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679600739"><a href="#local-6989586621679600739"><span class="hs-identifier">field</span></a></a><span> </span><a name="local-6989586621679600740"><a href="#local-6989586621679600740"><span class="hs-identifier">oldTempl</span></a></a><span> </span><a name="local-6989586621679600741"><a href="#local-6989586621679600741"><span class="hs-identifier">newTempl</span></a></a><span> </span><a name="local-6989586621679600742"><a href="#local-6989586621679600742"><span class="hs-identifier">diff</span></a></a><span> </span><a name="local-6989586621679600743"><a href="#local-6989586621679600743"><span class="hs-identifier">touched</span></a></a><span> </span><a name="local-6989586621679600744"><a href="#local-6989586621679600744"><span class="hs-identifier">fieldTy</span></a></a><span> </span><a name="local-6989586621679600745"><a href="#local-6989586621679600745"><span class="hs-identifier">newDiff</span></a></a><span> </span><a name="local-6989586621679600746"><a href="#local-6989586621679600746"><span class="hs-identifier">marker</span></a></a><span> </span><a name="local-6989586621679600747"><a href="#local-6989586621679600747"><span class="hs-identifier">s</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-108"></a><span>     </span><span class="hs-special">(</span><span> </span><span class="hs-special">'</span><span class="hs-special">(</span><a href="Lorentz.UStore.Types.html#UStoreFieldExt"><span class="hs-identifier hs-type">UStoreFieldExt</span></a><span> </span><a href="#local-6989586621679600746"><span class="hs-identifier hs-type">marker</span></a><span> </span><a href="#local-6989586621679600744"><span class="hs-identifier hs-type">fieldTy</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679600745"><span class="hs-identifier hs-type">newDiff</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">~</span><span> </span><a href="Lorentz.UStore.Migration.Diff.html#CoverDiff"><span class="hs-identifier hs-type">CoverDiff</span></a><span> </span><span class="hs-special">'</span><a href="Lorentz.UStore.Migration.Diff.html#DcRemove"><span class="hs-identifier hs-type">DcRemove</span></a><span> </span><a href="#local-6989586621679600739"><span class="hs-identifier hs-type">field</span></a><span> </span><a href="#local-6989586621679600742"><span class="hs-identifier hs-type">diff</span></a><span>
</span><a name="line-109"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Lorentz.UStore.Instr.html#HasUField"><span class="hs-identifier hs-type">HasUField</span></a><span> </span><a href="#local-6989586621679600739"><span class="hs-identifier hs-type">field</span></a><span> </span><a href="#local-6989586621679600744"><span class="hs-identifier hs-type">fieldTy</span></a><span> </span><a href="#local-6989586621679600740"><span class="hs-identifier hs-type">oldTempl</span></a><span>
</span><a name="line-110"></a><span>     </span><span class="hs-special">)</span><span>
</span><a name="line-111"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Label</span><span> </span><a href="#local-6989586621679600739"><span class="hs-identifier hs-type">field</span></a><span>
</span><a name="line-112"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Lorentz.Base.html#%3A-%3E"><span class="hs-identifier hs-type">MUStore</span></a><span> </span><a href="#local-6989586621679600740"><span class="hs-identifier hs-type">oldTempl</span></a><span> </span><a href="#local-6989586621679600741"><span class="hs-identifier hs-type">newTempl</span></a><span> </span><a href="#local-6989586621679600742"><span class="hs-identifier hs-type">diff</span></a><span> </span><a href="#local-6989586621679600743"><span class="hs-identifier hs-type">touched</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679600747"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-113"></a><span>  </span><span class="hs-operator">:-&gt;</span><span> </span><span class="hs-identifier hs-type">MUStore</span><span> </span><a href="#local-6989586621679600740"><span class="hs-identifier hs-type">oldTempl</span></a><span> </span><a href="#local-6989586621679600741"><span class="hs-identifier hs-type">newTempl</span></a><span> </span><a href="#local-6989586621679600745"><span class="hs-identifier hs-type">newDiff</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">field</span><span> </span><span class="hs-special">'</span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679600743"><span class="hs-identifier hs-type">touched</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679600747"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-114"></a><a name="migrateRemoveField"><a href="Lorentz.UStore.Migration.Blocks.html#migrateRemoveField"><span class="hs-identifier">migrateRemoveField</span></a></a><span> </span><span class="hs-keyword">label</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-115"></a><span>  </span><a href="Lorentz.UStore.Migration.Base.html#attachMigrationActionName"><span class="hs-identifier hs-var">attachMigrationActionName</span></a><span> </span><a href="Lorentz.UStore.Migration.Base.html#DDelAction"><span class="hs-identifier hs-var">DDelAction</span></a><span> </span><span class="hs-keyword">label</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Proxy</span><span> </span><span class="hs-glyph">@</span><a href="#local-6989586621679600744"><span class="hs-identifier hs-type">fieldTy</span></a><span class="hs-special">)</span><span> </span><a href="Lorentz.Base.html#%23"><span class="hs-operator hs-var">#</span></a><span>
</span><a name="line-116"></a><span>  </span><a href="Lorentz.Coercions.html#forcedCoerce_"><span class="hs-identifier hs-var">forcedCoerce_</span></a><span> </span><span class="hs-glyph">@</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Lorentz.UStore.Types.html#UStore"><span class="hs-identifier hs-type">UStore</span></a><span> </span><a href="#local-6989586621679600740"><span class="hs-identifier hs-type">oldTempl</span></a><span class="hs-special">)</span><span> </span><a href="Lorentz.Base.html#%23"><span class="hs-operator hs-var">#</span></a><span> </span><a href="Lorentz.UStore.Instr.html#ustoreRemoveFieldUnsafe"><span class="hs-identifier hs-var">ustoreRemoveFieldUnsafe</span></a><span> </span><span class="hs-keyword">label</span><span> </span><a href="Lorentz.Base.html#%23"><span class="hs-operator hs-var">#</span></a><span> </span><a href="Lorentz.Coercions.html#forcedCoerce_"><span class="hs-identifier hs-var">forcedCoerce_</span></a><span>
</span><a name="line-117"></a><span>
</span><a name="line-118"></a><span class="hs-comment">-- | Get and remove a field from old version of 'UStore'.</span><span>
</span><a name="line-119"></a><span class="hs-comment">--</span><span>
</span><a name="line-120"></a><span class="hs-comment">-- You probably want to use this more often than plain 'migrateRemoveField'.</span><span>
</span><a name="line-121"></a><span class="hs-identifier">migrateExtractField</span><span>
</span><a name="line-122"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679600730"><a href="#local-6989586621679600730"><span class="hs-identifier">field</span></a></a><span> </span><a name="local-6989586621679600731"><a href="#local-6989586621679600731"><span class="hs-identifier">oldTempl</span></a></a><span> </span><a name="local-6989586621679600732"><a href="#local-6989586621679600732"><span class="hs-identifier">newTempl</span></a></a><span> </span><a name="local-6989586621679600733"><a href="#local-6989586621679600733"><span class="hs-identifier">diff</span></a></a><span> </span><a name="local-6989586621679600734"><a href="#local-6989586621679600734"><span class="hs-identifier">touched</span></a></a><span> </span><a name="local-6989586621679600735"><a href="#local-6989586621679600735"><span class="hs-identifier">fieldTy</span></a></a><span> </span><a name="local-6989586621679600736"><a href="#local-6989586621679600736"><span class="hs-identifier">newDiff</span></a></a><span> </span><a name="local-6989586621679600737"><a href="#local-6989586621679600737"><span class="hs-identifier">marker</span></a></a><span> </span><a name="local-6989586621679600738"><a href="#local-6989586621679600738"><span class="hs-identifier">s</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-123"></a><span>     </span><span class="hs-special">(</span><span> </span><span class="hs-special">'</span><span class="hs-special">(</span><a href="Lorentz.UStore.Types.html#UStoreFieldExt"><span class="hs-identifier hs-type">UStoreFieldExt</span></a><span> </span><a href="#local-6989586621679600737"><span class="hs-identifier hs-type">marker</span></a><span> </span><a href="#local-6989586621679600735"><span class="hs-identifier hs-type">fieldTy</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679600736"><span class="hs-identifier hs-type">newDiff</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">~</span><span> </span><a href="Lorentz.UStore.Migration.Diff.html#CoverDiff"><span class="hs-identifier hs-type">CoverDiff</span></a><span> </span><span class="hs-special">'</span><a href="Lorentz.UStore.Migration.Diff.html#DcRemove"><span class="hs-identifier hs-type">DcRemove</span></a><span> </span><a href="#local-6989586621679600730"><span class="hs-identifier hs-type">field</span></a><span> </span><a href="#local-6989586621679600733"><span class="hs-identifier hs-type">diff</span></a><span>
</span><a name="line-124"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Lorentz.UStore.Instr.html#HasUField"><span class="hs-identifier hs-type">HasUField</span></a><span> </span><a href="#local-6989586621679600730"><span class="hs-identifier hs-type">field</span></a><span> </span><a href="#local-6989586621679600735"><span class="hs-identifier hs-type">fieldTy</span></a><span> </span><a href="#local-6989586621679600731"><span class="hs-identifier hs-type">oldTempl</span></a><span>
</span><a name="line-125"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Lorentz.UStore.Migration.Blocks.html#RequireUntouched"><span class="hs-identifier hs-type">RequireUntouched</span></a><span> </span><a href="#local-6989586621679600730"><span class="hs-identifier hs-type">field</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">field</span><span> </span><span class="hs-special">`</span><span class="hs-identifier hs-type">IsElem</span><span class="hs-special">`</span><span> </span><a href="#local-6989586621679600734"><span class="hs-identifier hs-type">touched</span></a><span class="hs-special">)</span><span>
</span><a name="line-126"></a><span>     </span><span class="hs-special">)</span><span>
</span><a name="line-127"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Label</span><span> </span><a href="#local-6989586621679600730"><span class="hs-identifier hs-type">field</span></a><span>
</span><a name="line-128"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Lorentz.Base.html#%3A-%3E"><span class="hs-identifier hs-type">MUStore</span></a><span> </span><a href="#local-6989586621679600731"><span class="hs-identifier hs-type">oldTempl</span></a><span> </span><a href="#local-6989586621679600732"><span class="hs-identifier hs-type">newTempl</span></a><span> </span><a href="#local-6989586621679600733"><span class="hs-identifier hs-type">diff</span></a><span> </span><a href="#local-6989586621679600734"><span class="hs-identifier hs-type">touched</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679600738"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-129"></a><span>  </span><span class="hs-operator">:-&gt;</span><span> </span><span class="hs-identifier hs-type">fieldTy</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier hs-type">MUStore</span><span> </span><a href="#local-6989586621679600731"><span class="hs-identifier hs-type">oldTempl</span></a><span> </span><a href="#local-6989586621679600732"><span class="hs-identifier hs-type">newTempl</span></a><span> </span><a href="#local-6989586621679600736"><span class="hs-identifier hs-type">newDiff</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">field</span><span> </span><span class="hs-special">'</span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679600734"><span class="hs-identifier hs-type">touched</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679600738"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-130"></a><a name="migrateExtractField"><a href="Lorentz.UStore.Migration.Blocks.html#migrateExtractField"><span class="hs-identifier">migrateExtractField</span></a></a><span> </span><span class="hs-keyword">label</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-131"></a><span>  </span><a href="Lorentz.UStore.Migration.Base.html#attachMigrationActionName"><span class="hs-identifier hs-var">attachMigrationActionName</span></a><span> </span><a href="Lorentz.UStore.Migration.Base.html#DDelAction"><span class="hs-identifier hs-var">DDelAction</span></a><span> </span><span class="hs-keyword">label</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Proxy</span><span> </span><span class="hs-glyph">@</span><a href="#local-6989586621679600735"><span class="hs-identifier hs-type">fieldTy</span></a><span class="hs-special">)</span><span> </span><a href="Lorentz.Base.html#%23"><span class="hs-operator hs-var">#</span></a><span>
</span><a name="line-132"></a><span>  </span><a href="Lorentz.UStore.Migration.Blocks.html#migrateGetField"><span class="hs-identifier hs-var">migrateGetField</span></a><span> </span><span class="hs-keyword">label</span><span> </span><a href="Lorentz.Base.html#%23"><span class="hs-operator hs-var">#</span></a><span> </span><a href="Lorentz.Instr.html#dip"><span class="hs-identifier hs-var">dip</span></a><span> </span><span class="hs-special">(</span><a href="Lorentz.UStore.Migration.Blocks.html#migrateRemoveField"><span class="hs-identifier hs-var">migrateRemoveField</span></a><span> </span><span class="hs-keyword">label</span><span class="hs-special">)</span><span>
</span><a name="line-133"></a><span>
</span><a name="line-134"></a><span class="hs-comment">-- | Remove field and write new one in place of it.</span><span>
</span><a name="line-135"></a><span class="hs-comment">--</span><span>
</span><a name="line-136"></a><span class="hs-comment">-- This is semantically equivalent to</span><span>
</span><a name="line-137"></a><span class="hs-comment">-- @dip (migrateRemoveField label) &gt;&gt; migrateAddField label@,</span><span>
</span><a name="line-138"></a><span class="hs-comment">-- but is cheaper.</span><span>
</span><a name="line-139"></a><span class="hs-identifier">migrateOverwriteField</span><span>
</span><a name="line-140"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679600718"><a href="#local-6989586621679600718"><span class="hs-identifier">field</span></a></a><span> </span><a name="local-6989586621679600719"><a href="#local-6989586621679600719"><span class="hs-identifier">oldTempl</span></a></a><span> </span><a name="local-6989586621679600720"><a href="#local-6989586621679600720"><span class="hs-identifier">newTempl</span></a></a><span> </span><a name="local-6989586621679600721"><a href="#local-6989586621679600721"><span class="hs-identifier">diff</span></a></a><span> </span><a name="local-6989586621679600722"><a href="#local-6989586621679600722"><span class="hs-identifier">touched</span></a></a><span> </span><a name="local-6989586621679600723"><a href="#local-6989586621679600723"><span class="hs-identifier">fieldTy</span></a></a><span> </span><a name="local-6989586621679600724"><a href="#local-6989586621679600724"><span class="hs-identifier">oldFieldTy</span></a></a><span>
</span><a name="line-141"></a><span>            </span><a name="local-6989586621679600725"><a href="#local-6989586621679600725"><span class="hs-identifier">marker</span></a></a><span> </span><a name="local-6989586621679600726"><a href="#local-6989586621679600726"><span class="hs-identifier">oldMarker</span></a></a><span> </span><a name="local-6989586621679600727"><a href="#local-6989586621679600727"><span class="hs-identifier">newDiff</span></a></a><span> </span><a name="local-6989586621679600728"><a href="#local-6989586621679600728"><span class="hs-identifier">newDiff0</span></a></a><span> </span><a name="local-6989586621679600729"><a href="#local-6989586621679600729"><span class="hs-identifier">s</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-142"></a><span>     </span><span class="hs-special">(</span><span> </span><span class="hs-special">'</span><span class="hs-special">(</span><a href="Lorentz.UStore.Types.html#UStoreFieldExt"><span class="hs-identifier hs-type">UStoreFieldExt</span></a><span> </span><a href="#local-6989586621679600726"><span class="hs-identifier hs-type">oldMarker</span></a><span> </span><a href="#local-6989586621679600724"><span class="hs-identifier hs-type">oldFieldTy</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679600728"><span class="hs-identifier hs-type">newDiff0</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">~</span><span> </span><a href="Lorentz.UStore.Migration.Diff.html#CoverDiff"><span class="hs-identifier hs-type">CoverDiff</span></a><span> </span><span class="hs-special">'</span><a href="Lorentz.UStore.Migration.Diff.html#DcRemove"><span class="hs-identifier hs-type">DcRemove</span></a><span> </span><a href="#local-6989586621679600718"><span class="hs-identifier hs-type">field</span></a><span> </span><a href="#local-6989586621679600721"><span class="hs-identifier hs-type">diff</span></a><span>
</span><a name="line-143"></a><span>     </span><span class="hs-special">,</span><span> </span><span class="hs-special">'</span><span class="hs-special">(</span><a href="Lorentz.UStore.Types.html#UStoreFieldExt"><span class="hs-identifier hs-type">UStoreFieldExt</span></a><span> </span><a href="#local-6989586621679600725"><span class="hs-identifier hs-type">marker</span></a><span> </span><a href="#local-6989586621679600723"><span class="hs-identifier hs-type">fieldTy</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679600727"><span class="hs-identifier hs-type">newDiff</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">~</span><span> </span><a href="Lorentz.UStore.Migration.Diff.html#CoverDiff"><span class="hs-identifier hs-type">CoverDiff</span></a><span> </span><span class="hs-special">'</span><a href="Lorentz.UStore.Migration.Diff.html#DcAdd"><span class="hs-identifier hs-type">DcAdd</span></a><span> </span><a href="#local-6989586621679600718"><span class="hs-identifier hs-type">field</span></a><span> </span><a href="#local-6989586621679600728"><span class="hs-identifier hs-type">newDiff0</span></a><span>
</span><a name="line-144"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Lorentz.UStore.Instr.html#HasUField"><span class="hs-identifier hs-type">HasUField</span></a><span> </span><a href="#local-6989586621679600718"><span class="hs-identifier hs-type">field</span></a><span> </span><a href="#local-6989586621679600723"><span class="hs-identifier hs-type">fieldTy</span></a><span> </span><a href="#local-6989586621679600720"><span class="hs-identifier hs-type">newTempl</span></a><span>
</span><a name="line-145"></a><span>     </span><span class="hs-special">)</span><span>
</span><a name="line-146"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Label</span><span> </span><a href="#local-6989586621679600718"><span class="hs-identifier hs-type">field</span></a><span>
</span><a name="line-147"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Lorentz.Base.html#%3A-%3E"><span class="hs-identifier hs-type">fieldTy</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="Lorentz.UStore.Migration.Base.html#MUStore"><span class="hs-identifier hs-type">MUStore</span></a><span> </span><a href="#local-6989586621679600719"><span class="hs-identifier hs-type">oldTempl</span></a><span> </span><a href="#local-6989586621679600720"><span class="hs-identifier hs-type">newTempl</span></a><span> </span><a href="#local-6989586621679600721"><span class="hs-identifier hs-type">diff</span></a><span> </span><a href="#local-6989586621679600722"><span class="hs-identifier hs-type">touched</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679600729"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-148"></a><span>  </span><span class="hs-operator">:-&gt;</span><span> </span><span class="hs-identifier hs-type">MUStore</span><span> </span><a href="#local-6989586621679600719"><span class="hs-identifier hs-type">oldTempl</span></a><span> </span><a href="#local-6989586621679600720"><span class="hs-identifier hs-type">newTempl</span></a><span> </span><a href="#local-6989586621679600727"><span class="hs-identifier hs-type">newDiff</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">field</span><span> </span><span class="hs-special">'</span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679600722"><span class="hs-identifier hs-type">touched</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679600729"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-149"></a><a name="migrateOverwriteField"><a href="Lorentz.UStore.Migration.Blocks.html#migrateOverwriteField"><span class="hs-identifier">migrateOverwriteField</span></a></a><span> </span><span class="hs-keyword">label</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-150"></a><span>  </span><a href="Lorentz.UStore.Migration.Base.html#attachMigrationActionName"><span class="hs-identifier hs-var">attachMigrationActionName</span></a><span> </span><span class="hs-special">(</span><a href="Lorentz.UStore.Migration.Base.html#DAddAction"><span class="hs-identifier hs-var">DAddAction</span></a><span> </span><span class="hs-string">&quot;overwrite&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">label</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Proxy</span><span> </span><span class="hs-glyph">@</span><a href="#local-6989586621679600723"><span class="hs-identifier hs-type">fieldTy</span></a><span class="hs-special">)</span><span> </span><a href="Lorentz.Base.html#%23"><span class="hs-operator hs-var">#</span></a><span>
</span><a name="line-151"></a><span>  </span><a href="Lorentz.Instr.html#dip"><span class="hs-identifier hs-var">dip</span></a><span> </span><span class="hs-special">(</span><a href="Lorentz.Coercions.html#forcedCoerce_"><span class="hs-identifier hs-var">forcedCoerce_</span></a><span> </span><span class="hs-glyph">@</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Lorentz.UStore.Types.html#UStore"><span class="hs-identifier hs-type">UStore</span></a><span> </span><a href="#local-6989586621679600720"><span class="hs-identifier hs-type">newTempl</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="Lorentz.Base.html#%23"><span class="hs-operator hs-var">#</span></a><span> </span><a href="Lorentz.UStore.Instr.html#ustoreSetField"><span class="hs-identifier hs-var">ustoreSetField</span></a><span> </span><span class="hs-keyword">label</span><span> </span><a href="Lorentz.Base.html#%23"><span class="hs-operator hs-var">#</span></a><span> </span><a href="Lorentz.Coercions.html#forcedCoerce_"><span class="hs-identifier hs-var">forcedCoerce_</span></a><span>
</span><a name="line-152"></a><span>
</span><a name="line-153"></a><span class="hs-comment">-- | Modify field which should stay in new version of storage.</span><span>
</span><a name="line-154"></a><span class="hs-comment">-- This does not affect remaining diff.</span><span>
</span><a name="line-155"></a><span class="hs-identifier">migrateModifyField</span><span>
</span><a name="line-156"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-6989586621679600711"><a href="#local-6989586621679600711"><span class="hs-identifier">field</span></a></a><span> </span><a name="local-6989586621679600712"><a href="#local-6989586621679600712"><span class="hs-identifier">oldTempl</span></a></a><span> </span><a name="local-6989586621679600713"><a href="#local-6989586621679600713"><span class="hs-identifier">newTempl</span></a></a><span> </span><a name="local-6989586621679600714"><a href="#local-6989586621679600714"><span class="hs-identifier">diff</span></a></a><span> </span><a name="local-6989586621679600715"><a href="#local-6989586621679600715"><span class="hs-identifier">touched</span></a></a><span> </span><a name="local-6989586621679600716"><a href="#local-6989586621679600716"><span class="hs-identifier">fieldTy</span></a></a><span> </span><a name="local-6989586621679600717"><a href="#local-6989586621679600717"><span class="hs-identifier">s</span></a></a><span class="hs-operator">.</span><span>
</span><a name="line-157"></a><span>     </span><span class="hs-special">(</span><span> </span><a href="Lorentz.UStore.Instr.html#HasUField"><span class="hs-identifier hs-type">HasUField</span></a><span> </span><a href="#local-6989586621679600711"><span class="hs-identifier hs-type">field</span></a><span> </span><a href="#local-6989586621679600716"><span class="hs-identifier hs-type">fieldTy</span></a><span> </span><a href="#local-6989586621679600712"><span class="hs-identifier hs-type">oldTempl</span></a><span>
</span><a name="line-158"></a><span>     </span><span class="hs-special">,</span><span> </span><a href="Lorentz.UStore.Instr.html#HasUField"><span class="hs-identifier hs-type">HasUField</span></a><span> </span><a href="#local-6989586621679600711"><span class="hs-identifier hs-type">field</span></a><span> </span><a href="#local-6989586621679600716"><span class="hs-identifier hs-type">fieldTy</span></a><span> </span><a href="#local-6989586621679600713"><span class="hs-identifier hs-type">newTempl</span></a><span>
</span><a name="line-159"></a><span>     </span><span class="hs-special">)</span><span>
</span><a name="line-160"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Label</span><span> </span><a href="#local-6989586621679600711"><span class="hs-identifier hs-type">field</span></a><span>
</span><a name="line-161"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Lorentz.Base.html#%3A-%3E"><span class="hs-identifier hs-type">fieldTy</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="Lorentz.UStore.Migration.Base.html#MUStore"><span class="hs-identifier hs-type">MUStore</span></a><span> </span><a href="#local-6989586621679600712"><span class="hs-identifier hs-type">oldTempl</span></a><span> </span><a href="#local-6989586621679600713"><span class="hs-identifier hs-type">newTempl</span></a><span> </span><a href="#local-6989586621679600714"><span class="hs-identifier hs-type">diff</span></a><span> </span><a href="#local-6989586621679600715"><span class="hs-identifier hs-type">touched</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679600717"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-162"></a><span>  </span><span class="hs-operator">:-&gt;</span><span> </span><span class="hs-identifier hs-type">MUStore</span><span> </span><a href="#local-6989586621679600712"><span class="hs-identifier hs-type">oldTempl</span></a><span> </span><a href="#local-6989586621679600713"><span class="hs-identifier hs-type">newTempl</span></a><span> </span><a href="#local-6989586621679600714"><span class="hs-identifier hs-type">diff</span></a><span> </span><a href="#local-6989586621679600715"><span class="hs-identifier hs-type">touched</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679600717"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-163"></a><a name="migrateModifyField"><a href="Lorentz.UStore.Migration.Blocks.html#migrateModifyField"><span class="hs-identifier">migrateModifyField</span></a></a><span> </span><span class="hs-keyword">label</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-164"></a><span>  </span><a href="Lorentz.UStore.Migration.Base.html#attachMigrationActionName"><span class="hs-identifier hs-var">attachMigrationActionName</span></a><span> </span><span class="hs-special">(</span><a href="Lorentz.UStore.Migration.Base.html#DAddAction"><span class="hs-identifier hs-var">DAddAction</span></a><span> </span><span class="hs-string">&quot;modify&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">label</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Proxy</span><span> </span><span class="hs-glyph">@</span><a href="#local-6989586621679600716"><span class="hs-identifier hs-type">fieldTy</span></a><span class="hs-special">)</span><span> </span><a href="Lorentz.Base.html#%23"><span class="hs-operator hs-var">#</span></a><span>
</span><a name="line-165"></a><span>  </span><a href="Lorentz.Instr.html#dip"><span class="hs-identifier hs-var">dip</span></a><span> </span><span class="hs-special">(</span><a href="Lorentz.Coercions.html#forcedCoerce_"><span class="hs-identifier hs-var">forcedCoerce_</span></a><span> </span><span class="hs-glyph">@</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><a href="Lorentz.UStore.Types.html#UStore"><span class="hs-identifier hs-type">UStore</span></a><span> </span><a href="#local-6989586621679600712"><span class="hs-identifier hs-type">oldTempl</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="Lorentz.Base.html#%23"><span class="hs-operator hs-var">#</span></a><span> </span><a href="Lorentz.UStore.Instr.html#ustoreSetField"><span class="hs-identifier hs-var">ustoreSetField</span></a><span> </span><span class="hs-keyword">label</span><span> </span><a href="Lorentz.Base.html#%23"><span class="hs-operator hs-var">#</span></a><span> </span><a href="Lorentz.Coercions.html#forcedCoerce_"><span class="hs-identifier hs-var">forcedCoerce_</span></a><span>
</span><a name="line-166"></a><span>
</span><a name="line-167"></a><span class="hs-comment">-- Migrating virtual submaps (strict migration)</span><span>
</span><a name="line-168"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-169"></a><span>
</span><a name="line-170"></a><span class="hs-comment">{- For now we do not support this kind of migration.

&quot;Strict&quot; means that we want to modify maps right here rather than signal to
do modification of each entry on first access to it (which would be simpler
in some sense).

Implementing this is slightly less trivial than migrating individial fields.
1. One needs current value of UStore picked from the contract, because it's
not possible to iterate over big_map from within a contract in the current mainnet.
Even if it was, we can't assume that iteration of the whole submap would fit
into gas limit of single transaction, thus iteration should be performed
from outside of the contract by someone who knows the current storage.

2. We need to split migration in batches smartly. Too big batches would hit
operation size limit, while small ones would cause high overhead of
contract/storage deserialization.
Will be resolved in TM-330.
-}</span><span>
</span><a name="line-188"></a><span>
</span><a name="line-189"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-190"></a><span class="hs-comment">-- Blocks for batched migrations</span><span>
</span><a name="line-191"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-192"></a><span>
</span><a name="line-193"></a><span class="hs-comment">-- | Define a migration atom.</span><span>
</span><a name="line-194"></a><span class="hs-comment">--</span><span>
</span><a name="line-195"></a><span class="hs-comment">-- It will be named automatically according to the set of actions it performs</span><span>
</span><a name="line-196"></a><span class="hs-comment">-- (via 'DMigrationActionDesc's).</span><span>
</span><a name="line-197"></a><span class="hs-comment">-- This may be want you want for small sequences of actions, but for complex ones</span><span>
</span><a name="line-198"></a><span class="hs-comment">-- consider using 'muBlockNamed'.</span><span>
</span><a name="line-199"></a><span class="hs-comment">-- Names are used in rendering migration plan.</span><span>
</span><a name="line-200"></a><span class="hs-identifier">muBlock</span><span>
</span><a name="line-201"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="hs-special">[</span><a href="Lorentz.UStore.Migration.Base.html#MUStore"><span class="hs-identifier hs-type">MUStore</span></a><span> </span><a href="#local-6989586621679600705"><span class="hs-identifier hs-type">o</span></a><span> </span><a href="#local-6989586621679600706"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679600707"><span class="hs-identifier hs-type">d1</span></a><span> </span><a href="#local-6989586621679600708"><span class="hs-identifier hs-type">t1</span></a><span class="hs-special">]</span><span> </span><span class="hs-operator">:-&gt;</span><span> </span><span class="hs-special">'</span><span class="hs-special">[</span><a href="Lorentz.UStore.Migration.Base.html#MUStore"><span class="hs-identifier hs-type">MUStore</span></a><span> </span><a href="#local-6989586621679600705"><span class="hs-identifier hs-type">o</span></a><span> </span><a href="#local-6989586621679600706"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679600709"><span class="hs-identifier hs-type">d2</span></a><span> </span><a href="#local-6989586621679600710"><span class="hs-identifier hs-type">t2</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-202"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Lorentz.UStore.Migration.Base.html#MigrationBlocks"><span class="hs-identifier hs-type">MigrationBlocks</span></a><span> </span><a href="#local-6989586621679600705"><span class="hs-identifier hs-type">o</span></a><span> </span><a href="#local-6989586621679600706"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679600707"><span class="hs-identifier hs-type">d1</span></a><span> </span><a href="#local-6989586621679600708"><span class="hs-identifier hs-type">t1</span></a><span> </span><a href="#local-6989586621679600709"><span class="hs-identifier hs-type">d2</span></a><span> </span><a href="#local-6989586621679600710"><span class="hs-identifier hs-type">t2</span></a><span>
</span><a name="line-203"></a><a name="muBlock"><a href="Lorentz.UStore.Migration.Blocks.html#muBlock"><span class="hs-identifier">muBlock</span></a></a><span> </span><a name="local-6989586621679600785"><a href="#local-6989586621679600785"><span class="hs-identifier">code</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-204"></a><span>  </span><a href="Lorentz.UStore.Migration.Base.html#MigrationBlocks"><span class="hs-identifier hs-var">MigrationBlocks</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">one</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Lorentz.UStore.Migration.Base.html#formMigrationAtom"><span class="hs-identifier hs-var">formMigrationAtom</span></a><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-205"></a><span>    </span><a href="Lorentz.Coercions.html#forcedCoerce_"><span class="hs-identifier hs-var">forcedCoerce_</span></a><span> </span><a href="Lorentz.Base.html#%23"><span class="hs-operator hs-var">#</span></a><span> </span><a href="#local-6989586621679600785"><span class="hs-identifier hs-var">code</span></a><span> </span><a href="Lorentz.Base.html#%23"><span class="hs-operator hs-var">#</span></a><span> </span><a href="Lorentz.Coercions.html#forcedCoerce_"><span class="hs-identifier hs-var">forcedCoerce_</span></a><span>
</span><a name="line-206"></a><span>
</span><a name="line-207"></a><span class="hs-comment">-- | Define a migration atom with given name.</span><span>
</span><a name="line-208"></a><span class="hs-comment">--</span><span>
</span><a name="line-209"></a><span class="hs-comment">-- Name will be used when rendering migration plan.</span><span>
</span><a name="line-210"></a><span class="hs-identifier">muBlockNamed</span><span>
</span><a name="line-211"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-212"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="hs-special">[</span><a href="Lorentz.UStore.Migration.Base.html#MUStore"><span class="hs-identifier hs-type">MUStore</span></a><span> </span><a href="#local-6989586621679600699"><span class="hs-identifier hs-type">o</span></a><span> </span><a href="#local-6989586621679600700"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679600701"><span class="hs-identifier hs-type">d1</span></a><span> </span><a href="#local-6989586621679600702"><span class="hs-identifier hs-type">t1</span></a><span class="hs-special">]</span><span> </span><span class="hs-operator">:-&gt;</span><span> </span><span class="hs-special">'</span><span class="hs-special">[</span><a href="Lorentz.UStore.Migration.Base.html#MUStore"><span class="hs-identifier hs-type">MUStore</span></a><span> </span><a href="#local-6989586621679600699"><span class="hs-identifier hs-type">o</span></a><span> </span><a href="#local-6989586621679600700"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679600703"><span class="hs-identifier hs-type">d2</span></a><span> </span><a href="#local-6989586621679600704"><span class="hs-identifier hs-type">t2</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-213"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Lorentz.UStore.Migration.Base.html#MigrationBlocks"><span class="hs-identifier hs-type">MigrationBlocks</span></a><span> </span><a href="#local-6989586621679600699"><span class="hs-identifier hs-type">o</span></a><span> </span><a href="#local-6989586621679600700"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679600701"><span class="hs-identifier hs-type">d1</span></a><span> </span><a href="#local-6989586621679600702"><span class="hs-identifier hs-type">t1</span></a><span> </span><a href="#local-6989586621679600703"><span class="hs-identifier hs-type">d2</span></a><span> </span><a href="#local-6989586621679600704"><span class="hs-identifier hs-type">t2</span></a><span>
</span><a name="line-214"></a><a name="muBlockNamed"><a href="Lorentz.UStore.Migration.Blocks.html#muBlockNamed"><span class="hs-identifier">muBlockNamed</span></a></a><span> </span><a name="local-6989586621679600786"><a href="#local-6989586621679600786"><span class="hs-identifier">name</span></a></a><span> </span><a name="local-6989586621679600787"><a href="#local-6989586621679600787"><span class="hs-identifier">code</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-215"></a><span>  </span><a href="Lorentz.UStore.Migration.Base.html#MigrationBlocks"><span class="hs-identifier hs-var">MigrationBlocks</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">one</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><a href="Lorentz.UStore.Migration.Base.html#formMigrationAtom"><span class="hs-identifier hs-var">formMigrationAtom</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621679600786"><span class="hs-identifier hs-var">name</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-216"></a><span>    </span><a href="Lorentz.Coercions.html#forcedCoerce_"><span class="hs-identifier hs-var">forcedCoerce_</span></a><span> </span><a href="Lorentz.Base.html#%23"><span class="hs-operator hs-var">#</span></a><span> </span><a href="#local-6989586621679600787"><span class="hs-identifier hs-var">code</span></a><span> </span><a href="Lorentz.Base.html#%23"><span class="hs-operator hs-var">#</span></a><span> </span><a href="Lorentz.Coercions.html#forcedCoerce_"><span class="hs-identifier hs-var">forcedCoerce_</span></a><span>
</span><a name="line-217"></a><span>
</span><a name="line-218"></a><span class="hs-comment">-- | Composition of migration blocks.</span><span>
</span><a name="line-219"></a><span class="hs-special">(</span><span class="hs-operator">&lt;--&gt;</span><span class="hs-special">)</span><span>
</span><a name="line-220"></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="Lorentz.UStore.Migration.Base.html#MigrationBlocks"><span class="hs-identifier hs-type">MigrationBlocks</span></a><span> </span><a href="#local-6989586621679600691"><span class="hs-identifier hs-type">o</span></a><span> </span><a href="#local-6989586621679600692"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679600693"><span class="hs-identifier hs-type">d1</span></a><span> </span><a href="#local-6989586621679600694"><span class="hs-identifier hs-type">t1</span></a><span> </span><a href="#local-6989586621679600695"><span class="hs-identifier hs-type">d2</span></a><span> </span><a href="#local-6989586621679600696"><span class="hs-identifier hs-type">t2</span></a><span>
</span><a name="line-221"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Lorentz.UStore.Migration.Base.html#MigrationBlocks"><span class="hs-identifier hs-type">MigrationBlocks</span></a><span> </span><a href="#local-6989586621679600691"><span class="hs-identifier hs-type">o</span></a><span> </span><a href="#local-6989586621679600692"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679600695"><span class="hs-identifier hs-type">d2</span></a><span> </span><a href="#local-6989586621679600696"><span class="hs-identifier hs-type">t2</span></a><span> </span><a href="#local-6989586621679600697"><span class="hs-identifier hs-type">d3</span></a><span> </span><a href="#local-6989586621679600698"><span class="hs-identifier hs-type">t3</span></a><span>
</span><a name="line-222"></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Lorentz.UStore.Migration.Base.html#MigrationBlocks"><span class="hs-identifier hs-type">MigrationBlocks</span></a><span> </span><a href="#local-6989586621679600691"><span class="hs-identifier hs-type">o</span></a><span> </span><a href="#local-6989586621679600692"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679600693"><span class="hs-identifier hs-type">d1</span></a><span> </span><a href="#local-6989586621679600694"><span class="hs-identifier hs-type">t1</span></a><span> </span><a href="#local-6989586621679600697"><span class="hs-identifier hs-type">d3</span></a><span> </span><a href="#local-6989586621679600698"><span class="hs-identifier hs-type">t3</span></a><span>
</span><a name="line-223"></a><a href="Lorentz.UStore.Migration.Base.html#MigrationBlocks"><span class="hs-identifier hs-var">MigrationBlocks</span></a><span> </span><a name="local-6989586621679600788"><a href="#local-6989586621679600788"><span class="hs-identifier">blocks1</span></a></a><span> </span><a name="%3C--%3E"><a href="Lorentz.UStore.Migration.Blocks.html#%3C--%3E"><span class="hs-operator">&lt;--&gt;</span></a></a><span> </span><a href="Lorentz.UStore.Migration.Base.html#MigrationBlocks"><span class="hs-identifier hs-var">MigrationBlocks</span></a><span> </span><a name="local-6989586621679600789"><a href="#local-6989586621679600789"><span class="hs-identifier">blocks2</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-224"></a><span>  </span><a href="Lorentz.UStore.Migration.Base.html#MigrationBlocks"><span class="hs-identifier hs-var">MigrationBlocks</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679600788"><span class="hs-identifier hs-var">blocks1</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621679600789"><span class="hs-identifier hs-var">blocks2</span></a><span class="hs-special">)</span><span>
</span><a name="line-225"></a><span class="hs-keyword">infixl</span><span> </span><span class="hs-number">2</span><span> </span><a href="Lorentz.UStore.Migration.Blocks.html#%3C--%3E"><span class="hs-operator hs-var">&lt;--&gt;</span></a><span>
</span><a name="line-226"></a><span>
</span><a name="line-227"></a><span class="hs-comment">{- | This is '$' operator with priority higher than '&lt;--&gt;'.

It allows you writing

@
mkUStoreBatchedMigration =
  muBlock $: do
    migrateAddField ...
  &lt;--&gt;
  muBlock $: do
    migrateRemoveField ...
@

Alternatively, @BlockArguments@ extension can be used.
-}</span><span>
</span><a name="line-242"></a><span class="hs-special">(</span><span class="hs-operator">$:</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679600689"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679600690"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679600689"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679600690"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-243"></a><span class="hs-special">(</span><a name="%24%3A"><a href="Lorentz.UStore.Migration.Blocks.html#%24%3A"><span class="hs-operator">$:</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">$</span><span class="hs-special">)</span><span>
</span><a name="line-244"></a><span class="hs-keyword">infixr</span><span> </span><span class="hs-number">7</span><span> </span><a href="Lorentz.UStore.Migration.Blocks.html#%24%3A"><span class="hs-operator hs-var">$:</span></a><span>
</span><a name="line-245"></a><span>
</span><a name="line-246"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-247"></a><span class="hs-comment">-- Common</span><span>
</span><a name="line-248"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-249"></a><span>
</span><a name="line-250"></a><span class="hs-comment">-- | Get the old version of storage.</span><span>
</span><a name="line-251"></a><span class="hs-comment">--</span><span>
</span><a name="line-252"></a><span class="hs-comment">-- This can be applied only in the beginning of migration.</span><span>
</span><a name="line-253"></a><span class="hs-comment">--</span><span>
</span><a name="line-254"></a><span class="hs-comment">-- In fact this function is not very useful, all required operations should</span><span>
</span><a name="line-255"></a><span class="hs-comment">-- be available for 'MUStore', but leaving it here just in case.</span><span>
</span><a name="line-256"></a><span class="hs-identifier">mustoreToOld</span><span>
</span><a name="line-257"></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="Lorentz.UStore.Migration.Blocks.html#RequireBeInitial"><span class="hs-identifier hs-type">RequireBeInitial</span></a><span> </span><a href="#local-6989586621679600684"><span class="hs-identifier hs-type">touched</span></a><span>
</span><a name="line-258"></a><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Lorentz.Base.html#%3A-%3E"><span class="hs-identifier hs-type">MUStore</span></a><span> </span><a href="#local-6989586621679600685"><span class="hs-identifier hs-type">oldTemplate</span></a><span> </span><a href="#local-6989586621679600686"><span class="hs-identifier hs-type">newTemplate</span></a><span> </span><a href="#local-6989586621679600687"><span class="hs-identifier hs-type">remDiff</span></a><span> </span><a href="#local-6989586621679600684"><span class="hs-identifier hs-type">touched</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679600688"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-259"></a><span>  </span><span class="hs-operator">:-&gt;</span><span> </span><span class="hs-identifier hs-type">UStore</span><span> </span><a href="#local-6989586621679600685"><span class="hs-identifier hs-type">oldTemplate</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679600688"><span class="hs-identifier hs-type">s</span></a><span>
</span><a name="line-260"></a><a name="mustoreToOld"><a href="Lorentz.UStore.Migration.Blocks.html#mustoreToOld"><span class="hs-identifier">mustoreToOld</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Lorentz.Coercions.html#forcedCoerce_"><span class="hs-identifier hs-var">forcedCoerce_</span></a><span>
</span><a name="line-261"></a><span>
</span><a name="line-262"></a><span class="hs-keyword">class</span><span> </span><a name="MigrationFinishCheckPosition"><a href="Lorentz.UStore.Migration.Blocks.html#MigrationFinishCheckPosition"><span class="hs-identifier">MigrationFinishCheckPosition</span></a></a><span> </span><a name="local-6989586621679600665"><a href="#local-6989586621679600665"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-263"></a><span>  </span><span class="hs-comment">-- | Put this in the end of migration script to get a human-readable message</span><span>
</span><a name="line-264"></a><span>  </span><span class="hs-comment">-- about remaining diff which yet should be covered.</span><span>
</span><a name="line-265"></a><span>  </span><span class="hs-comment">-- Use of this function in migration is fully optional.</span><span>
</span><a name="line-266"></a><span>  </span><span class="hs-comment">--</span><span>
</span><a name="line-267"></a><span>  </span><span class="hs-comment">-- This function is not part of 'mkUStoreMigration' for the sake of</span><span>
</span><a name="line-268"></a><span>  </span><span class="hs-comment">-- proper error messages ordering, during development</span><span>
</span><a name="line-269"></a><span>  </span><span class="hs-comment">-- you probably want errors in migration script to be located earlier</span><span>
</span><a name="line-270"></a><span>  </span><span class="hs-comment">-- in code than errors about not fully covered diff (if you used</span><span>
</span><a name="line-271"></a><span>  </span><span class="hs-comment">-- to fix errors in the same order in which they appear).</span><span>
</span><a name="line-272"></a><span>  </span><a name="migrationFinish"><a href="Lorentz.UStore.Migration.Blocks.html#migrationFinish"><span class="hs-identifier">migrationFinish</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="#local-6989586621679600665"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-273"></a><span>
</span><a name="line-274"></a><span class="hs-comment">-- | This version can be used in 'mkUStoreMigration'.</span><span>
</span><a name="line-275"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">i</span><span> </span><span class="hs-glyph">~</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MUStore</span><span> </span><a href="#local-6989586621679600678"><span class="hs-identifier hs-type">oldTempl</span></a><span> </span><a href="#local-6989586621679600679"><span class="hs-identifier hs-type">newTempl</span></a><span> </span><a href="#local-6989586621679600680"><span class="hs-identifier hs-type">diff</span></a><span> </span><a href="#local-6989586621679600681"><span class="hs-identifier hs-type">touched</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679600682"><span class="hs-identifier hs-type">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-276"></a><span>         </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">o</span><span> </span><span class="hs-glyph">~</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MUStore</span><span> </span><a href="#local-6989586621679600678"><span class="hs-identifier hs-type">oldTempl</span></a><span> </span><a href="#local-6989586621679600679"><span class="hs-identifier hs-type">newTempl</span></a><span> </span><span class="hs-special">'</span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621679600681"><span class="hs-identifier hs-type">touched</span></a><span> </span><span class="hs-glyph">:</span><span> </span><a href="#local-6989586621679600682"><span class="hs-identifier hs-type">s</span></a><span class="hs-special">)</span><span>
</span><a name="line-277"></a><span>         </span><span class="hs-special">,</span><span> </span><a href="Lorentz.UStore.Migration.Diff.html#RequireEmptyDiff"><span class="hs-identifier hs-type">RequireEmptyDiff</span></a><span> </span><a href="#local-6989586621679600680"><span class="hs-identifier hs-type">diff</span></a><span>
</span><a name="line-278"></a><span>         </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-279"></a><span>         </span><a href="Lorentz.UStore.Migration.Blocks.html#MigrationFinishCheckPosition"><span class="hs-identifier hs-type">MigrationFinishCheckPosition</span></a><span> </span><span class="hs-special">(</span><a href="Lorentz.Base.html#%3A-%3E"><span class="hs-identifier hs-type">i</span></a><span> </span><a href="Lorentz.Base.html#%3A-%3E"><span class="hs-operator hs-type">:-&gt;</span></a><span> </span><a href="#local-6989586621679600683"><span class="hs-identifier hs-type">o</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-280"></a><span>  </span><a name="local-8214565720324375561"><a href="Lorentz.UStore.Migration.Blocks.html#migrationFinish"><span class="hs-identifier">migrationFinish</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Lorentz.Coercions.html#forcedCoerce_"><span class="hs-identifier hs-var">forcedCoerce_</span></a><span>
</span><a name="line-281"></a><span>
</span><a name="line-282"></a><span class="hs-comment">-- | This version can be used in 'mkUStoreMultiMigration' as the last migration</span><span>
</span><a name="line-283"></a><span class="hs-comment">-- block.</span><span>
</span><a name="line-284"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><a href="Lorentz.UStore.Migration.Diff.html#RequireEmptyDiff"><span class="hs-identifier hs-type">RequireEmptyDiff</span></a><span> </span><a href="#local-6989586621679600672"><span class="hs-identifier hs-type">d1</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">t1</span><span> </span><span class="hs-glyph">~</span><span> </span><a href="#local-6989586621679600674"><span class="hs-identifier hs-type">t2</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><a name="line-285"></a><span>         </span><a href="Lorentz.UStore.Migration.Blocks.html#MigrationFinishCheckPosition"><span class="hs-identifier hs-type">MigrationFinishCheckPosition</span></a><span> </span><span class="hs-special">(</span><a href="Lorentz.UStore.Migration.Base.html#MigrationBlocks"><span class="hs-identifier hs-type">MigrationBlocks</span></a><span> </span><a href="#local-6989586621679600675"><span class="hs-identifier hs-type">o</span></a><span> </span><a href="#local-6989586621679600676"><span class="hs-identifier hs-type">n</span></a><span> </span><a href="#local-6989586621679600672"><span class="hs-identifier hs-type">d1</span></a><span> </span><a href="#local-6989586621679600673"><span class="hs-identifier hs-type">t1</span></a><span> </span><span class="hs-special">'</span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><a href="#local-6989586621679600674"><span class="hs-identifier hs-type">t2</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-286"></a><span>  </span><a name="local-8214565720324375561"><a href="Lorentz.UStore.Migration.Blocks.html#migrationFinish"><span class="hs-identifier">migrationFinish</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Lorentz.UStore.Migration.Base.html#MigrationBlocks"><span class="hs-identifier hs-var">MigrationBlocks</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-287"></a></pre></body></html>